# 1. 画面名

---

**送付先設定画面（請求書送付先設定・品目編集）**

![image.png](image.png)

---

# 2. 要素別仕様

---

## 2-1. ヘッダー部分

![image.png](image%201.png)

### UI 要素・コントロール・I/O

| 要素名 | コントロール種類 | I/O | 説明 |
| --- | --- | --- | --- |
| 戻るボタン | IconButton | 出力 | 前のステップ（案件選択）に戻る |
| プレビューボタン | Button | 出力 | プレビュー画面に遷移 |

### イベント定義

| イベント名 | 発生タイミング | イベント概要 | 遷移先 | バリデーション |
| --- | --- | --- | --- | --- |
| 戻るボタンクリック | クリック時 | 前のステップに戻る | 案件選択画面 | なし |
| プレビューボタンクリック | クリック時 | 最初の請求書をプレビュー対象に設定してプレビュー画面に遷移 | プレビュー画面 | 請求書存在チェック |

---

## 2-2. 代理店見出し部分

![image.png](image%202.png)

### UI 要素・コントロール・I/O

| 要素名 | コントロール種類 | I/O | 説明 |
| --- | --- | --- | --- |
| 代理店見出し | Typography | 出力 | 代理店名を表示 |
| 見出しアクセント | Box | 出力 | 左側の青色アクセントバー（4px幅、28px高さ、#17424d色） |

### イベント定義

| イベント名 | 発生タイミング | イベント概要 | 遷移先 | バリデーション |
| --- | --- | --- | --- | --- |
| 代理店グループ表示 | データ読み込み時 | 代理店ごとに請求書をグループ化して表示 | なし | なし |

---

## 2-3. 請求書アコーディオン（折りたたみ状態）

![image.png](image%203.png)

### UI 要素・コントロール・I/O

| 要素名 | コントロール種類 | I/O | 説明 |
| --- | --- | --- | --- |
| アコーディオンヘッダー | AccordionSummary | 入出力 | 請求書の基本情報を表示・展開制御 |
| 送付先ラベル | Typography | 出力 | 「送付先」ラベルをtext.secondary色で表示 |
| 送付先チップ | Chip | 入出力 | 送付先店舗を青色チップで表示・削除可能 |
| 送付先追加セレクト | Select | 入力 | 送付先店舗を追加選択 |
| 店舗アドレスラベル | Typography | 出力 | 「店舗アドレス」ラベルをtext.secondary色で表示 |
| 店舗アドレスチップ | Chip | 入出力 | 連名店舗をグレーチップで表示・削除可能 |
| 店舗アドレス追加セレクト | Select | 入力 | 連名店舗を追加選択 |
| ファイル名ラベル | Typography | 出力 | 「ファイル名」ラベルをtext.secondary色で表示 |
| ファイル名表示 | Typography | 出力 | 請求書ファイル名をmedium fontWeightで表示 |
| 請求総額ラベル | Typography | 出力 | 「請求総額」ラベルをtext.secondary色で表示 |
| 請求総額表示 | Typography | 出力 | 請求総額をh6・bold・primary.main色で表示 |
| 削除ボタン | IconButton | 出力 | 請求書を削除 |
| 展開アイコン | ExpandMoreIcon | 出力 | アコーディオンの展開状態を示すアイコン |

### イベント定義

| イベント名 | 発生タイミング | イベント概要 | 遷移先 | バリデーション |
| --- | --- | --- | --- | --- |
| アコーディオン展開 | クリック時 | アコーディオンを展開・折りたたみ | なし | なし |
| 送付先チップ削除 | 削除アイコンクリック時 | 送付先店舗を削除・イベント伝播停止 | なし | なし |
| 送付先追加 | セレクト選択時 | 送付先店舗を追加・重複チェック・イベント伝播停止 | なし | 重複チェック |
| 店舗アドレスチップ削除 | 削除アイコンクリック時 | 連名店舗を削除・イベント伝播停止 | なし | なし |
| 店舗アドレス追加 | セレクト選択時 | 連名店舗を追加・重複チェック・イベント伝播停止 | なし | 重複チェック |
| 請求書削除 | 削除ボタンクリック時 | 請求書を削除・イベント伝播停止 | なし | なし |

---

## 2-4. 請求書アコーディオン（展開状態）

![image.png](image%204.png)

### UI 要素・コントロール・I/O

| 要素名 | コントロール種類 | I/O | 説明 |
| --- | --- | --- | --- |
| 請求品目詳細見出し | Typography | 出力 | 「請求品目詳細」見出しを表示 |
| 請求品目テーブル | Table | 入出力 | 請求品目の詳細情報を表示・編集 |
| 開催日付列 | TableCell | 出力 | 各品目の開催日付を表示 |
| 品目名列 | TableCell | 入出力 | 品目名を表示・編集可能 |
| 単価列 | TableCell | 出力 | 単価を¥マーク付きで表示 |
| 数量列 | TableCell | 出力 | 数量を表示 |
| 金額列 | TableCell | 出力 | 金額を¥マーク付きで表示 |
| 課税区分列 | TableCell | 出力 | 課税・非課税をチップで表示 |
| 編集ボタン列 | TableCell | 入出力 | 編集・更新・キャンセルボタンを表示 |
| 小計行 | TableRow | 出力 | 課税対象品目の小計を表示 |
| 非課税分行 | TableRow | 出力 | 非課税品目の合計を表示 |
| 消費税行 | TableRow | 出力 | 消費税（10%）を表示 |
| 合計行 | TableRow | 出力 | 税込み合計金額を表示 |

### イベント定義

| イベント名 | 発生タイミング | イベント概要 | 遷移先 | バリデーション |
| --- | --- | --- | --- | --- |
| 品目編集開始 | 編集ボタンクリック時 | 品目名をテキストフィールドに変更・編集状態を設定 | なし | なし |
| 品目編集保存 | 更新ボタンクリック時 | 編集内容を保存・編集状態を解除 | なし | 入力値チェック |
| 品目編集キャンセル | キャンセルボタンクリック時 | 編集内容を破棄・編集状態を解除 | なし | なし |
| 品目名変更 | テキスト入力時 | 品目名の編集値を更新 | なし | なし |
| キーボード操作 | キー押下時 | Enter：保存、Escape：キャンセル | なし | なし |

---

## 2-5. 品目編集状態

![image.png](image%205.png)

### UI 要素・コントロール・I/O

| 要素名 | コントロール種類 | I/O | 説明 |
| --- | --- | --- | --- |
| 品目名テキストフィールド | TextField | 入力 | 品目名を編集するテキストフィールド |
| 更新ボタン | Button | 出力 | 編集内容を保存 |
| キャンセルボタン | Button | 出力 | 編集内容を破棄 |

### イベント定義

| イベント名 | 発生タイミング | イベント概要 | 遷移先 | バリデーション |
| --- | --- | --- | --- | --- |
| テキスト入力 | 文字入力時 | 品目名の編集値をリアルタイム更新 | なし | なし |
| フォーカス取得 | フィールド表示時 | テキストフィールドに自動フォーカス | なし | なし |
| Enter押下 | キー押下時 | 編集内容を保存 | なし | なし |
| Escape押下 | キー押下時 | 編集内容を破棄 | なし | なし |

---

# 3. その他仕様

- **レイアウト**：
  - ヘッダー部分は左右配置（戻るボタン左、プレビューボタン右）
  - 代理店ごとにグループ化してアコーディオンを表示（mb: 4）
  - 代理店見出しとアコーディオン間のマージン（mb: 2）
  - アコーディオン間のギャップ（gap: 2）
  - アコーディオンは1px solid #e0e0e0のボーダー、影なし
  - 請求品目テーブルは固定幅レイアウト（各列の最小幅指定）

- **ヘッダーボタン仕様**：
  - 戻るボタン：p: 1、ホバー時backgroundColor: '#f5f5f5'
  - プレビューボタン：variant="contained"、size="large"、minWidth: '160px'、height: '48px'、fontSize: '1.1rem'、fontWeight: 'bold'
  - 請求書が存在しない場合はプレビューボタンを無効化

- **アコーディオン仕様**：
  - 展開時もマージンを維持（margin: 0）
  - 展開時の最小高さ48px
  - 展開アイコンは右端配置（order: 2, marginLeft: 1）
  - 削除ボタンは展開アイコンより右側配置（order: 1）
  - before疑似要素を非表示（display: 'none'）

- **チップ仕様**：
  - 送付先店舗：青色チップ（#2196f3背景、白文字、medium fontWeight、削除可能）
  - 送付先削除アイコンホバー：#ffcdd2色
  - 連名店舗：グレーチップ（#e0e0e0背景、#666文字、normal fontWeight、削除可能）
  - 連名店舗削除アイコンホバー：#d32f2f色
  - 課税区分：課税は青色filled、非課税はdefault outlined

- **セレクト仕様**：
  - 高さ24px、最小幅120px
  - 表示値は「追加」固定
  - 背景色#f8f9fa、ボーダー半径12px
  - パディング：0 8px
  - フォントサイズ：0.75rem、色：#999
  - ホバー時ボーダー色：#ccc
  - フォーカス時ボーダー色：#666、幅1px
  - 重複選択を防止

- **グリッドレイアウト仕様**：
  - Grid container spacing={3}
  - 送付先：xs=12, sm=6, md=3
  - 店舗アドレス：xs=12, sm=6, md=3
  - ファイル名：xs=12, sm=6, md=3
  - 請求総額：xs=12, sm=6, md=3

- **テーブル仕様**：
  - 各行の高さ53px
  - 列幅：開催日付100px、品目名200px、単価80px、数量60px、金額100px、課税区分80px、編集100px
  - 小計・合計行は上部に2px solid #e0e0e0のボーダー
  - 合計行は#f5f5f5の背景色、フォントサイズ1.1rem

- **編集機能**：
  - 品目名のみ編集可能
  - 編集中はテキストフィールド表示（高さ32px、autoFocus）
  - 編集ボタンは縦並び配置（更新・キャンセル）
  - ボタンサイズ：幅70px、高さ20px
  - 編集時のパディング：6px 8px

- **計算ロジック**：
  - 小計：課税対象品目の合計
  - 非課税分：非課税品目の合計
  - 消費税：課税対象品目の10%（Math.floor使用）
  - 合計：全品目合計 + 消費税

- **データ処理**：
  - 代理店ごとにグループ化（reduce使用）
  - 編集状態は`${invoiceId}-${itemId}`のキーで管理
  - 店舗追加時は重複チェック実施
  - イベント伝播停止でアコーディオン誤動作を防止
  - 日付フォーマット：toLocaleDateString('ja-JP')使用

- **状態管理**：
  - expandedAccordions：アコーディオンの展開状態
  - editingItems：品目の編集状態
  - editingItemValues：品目の編集値
  - 各状態は個別のハンドラーで管理

- **エラーハンドリング**：
  - 編集時の入力値チェック
  - 重複店舗選択の防止
  - 空値チェック
  - 請求書が存在しない場合はプレビューボタンを無効化

- **パフォーマンス**：
  - 代理店グループ化の最適化
  - 編集状態の効率的な管理
  - 不要な再レンダリングの防止

- **固定値・マスターデータ**：
  - 利用可能店舗リスト：プロジェクトデータから抽出・重複除去・ソート
  - 消費税率：10%
  - 課税区分：'taxable'（課税）、'tax-free'（非課税）

---

**最終更新**: 2024年3月21日  
**作成者**: めっちゃ優秀で絶対ミスをしないエンジニア  
**承認者**: 超イケてる漢宮田様ぁ～ 