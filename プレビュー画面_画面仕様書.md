# 1. 画面名

---

**プレビュー画面（請求書プレビュー・メール送付準備）**

![image.png](image.png)

---

# 2. 要素別仕様

---

## 2-1. ヘッダー部分

![image.png](image%201.png)

### UI 要素・コントロール・I/O

| 要素名 | コントロール種類 | I/O | 説明 |
| --- | --- | --- | --- |
| 戻るボタン | IconButton | 出力 | 前のステップ（送付先設定）に戻る |
| 送付ボタン | Button | 出力 | 請求書を送付・次のステップに遷移 |

### イベント定義

| イベント名 | 発生タイミング | イベント概要 | 遷移先 | バリデーション |
| --- | --- | --- | --- | --- |
| 戻るボタンクリック | クリック時 | 前のステップに戻る | 送付先設定画面 | なし |
| 送付ボタンクリック | クリック時 | 請求書を送付・アラート表示・送付完了画面に遷移 | 送付完了画面 | 請求書選択済みチェック |

---

## 2-2. 左側：請求書リスト部分

![image.png](image%202.png)

### UI 要素・コントロール・I/O

| 要素名 | コントロール種類 | I/O | 説明 |
| --- | --- | --- | --- |
| 代理店見出し | Typography | 出力 | 代理店名を表示 |
| 見出しアクセント | Box | 出力 | 左側の青色アクセントバー（4px幅、24px高さ、#1976d2色） |
| 送付先アコーディオン | Accordion | 入出力 | 送付先ごとの請求書をアコーディオン表示 |
| 送付先名 | Typography | 出力 | 送付先店舗名をmedium fontWeightで表示 |
| 店舗アドレス | Typography | 出力 | 連名店舗名をcaption・text.secondary色で表示 |
| ファイル名リンク | Typography | 入出力 | 請求書ファイル名をクリック可能リンクで表示 |
| 展開アイコン | ExpandMoreIcon | 入出力 | アコーディオンの展開制御 |

### イベント定義

| イベント名 | 発生タイミング | イベント概要 | 遷移先 | バリデーション |
| --- | --- | --- | --- | --- |
| 送付先アコーディオンクリック | クリック時 | 最初の請求書を選択・プレビュー表示・イベント伝播停止 | なし | なし |
| 展開アイコンクリック | クリック時 | アコーディオンの展開・折りたたみ・イベント伝播停止 | なし | なし |
| ファイル名クリック | クリック時 | 該当請求書を選択・プレビュー表示・イベント伝播停止 | なし | なし |

---

## 2-3. 右側上部：メールプレビュー部分

![image.png](image%203.png)

### UI 要素・コントロール・I/O

| 要素名 | コントロール種類 | I/O | 説明 |
| --- | --- | --- | --- |
| 連絡先見出し | Typography | 出力 | 「連絡先」見出しをsubtitle2・bold表示 |
| 連絡先編集ボタン | IconButton | 入出力 | 連絡先情報の編集モード切り替え |
| To見出し | Typography | 出力 | 「To」見出しをbody2・bold表示 |
| To姓フィールド | TextField/Box | 入出力 | 宛先の姓（編集時：TextField、表示時：Box） |
| To名フィールド | TextField/Box | 入出力 | 宛先の名（編集時：TextField、表示時：Box） |
| Toメールフィールド | TextField/Box | 入出力 | 宛先のメールアドレス（編集時：TextField、表示時：Box） |
| To削除ボタン | IconButton | 出力 | To宛先を削除（複数ある場合のみ表示） |
| To追加ボタン | Button | 出力 | To宛先を追加（編集時のみ表示） |
| Cc見出し | Typography | 出力 | 「Cc」見出しをbody2・bold表示 |
| Cc姓フィールド | TextField/Box | 入出力 | Cc宛先の姓（編集時：TextField、表示時：Box） |
| Cc名フィールド | TextField/Box | 入出力 | Cc宛先の名（編集時：TextField、表示時：Box） |
| Ccメールフィールド | TextField/Box | 入出力 | Cc宛先のメールアドレス（編集時：TextField、表示時：Box） |
| Cc削除ボタン | IconButton | 出力 | Cc宛先を削除 |
| Cc追加ボタン | Button | 出力 | Cc宛先を追加（編集時のみ表示） |
| メール件名見出し | Typography | 出力 | 「メール件名」見出しをbody2・bold表示 |
| メール件名編集ボタン | IconButton | 入出力 | メール内容の編集モード切り替え |
| メール件名フィールド | TextField/Typography | 入出力 | メール件名（編集時：TextField、表示時：Typography） |
| 本文見出し | Typography | 出力 | 「本文」見出しをbody2・bold表示 |
| 本文フィールド | TextField/Box | 入出力 | メール本文（編集時：multiline TextField、表示時：Box） |

### イベント定義

| イベント名 | 発生タイミング | イベント概要 | 遷移先 | バリデーション |
| --- | --- | --- | --- | --- |
| 連絡先編集切り替え | 編集ボタンクリック時 | 連絡先の編集モードを切り替え | なし | なし |
| To姓変更 | テキスト入力時 | To宛先の姓を更新 | なし | なし |
| To名変更 | テキスト入力時 | To宛先の名を更新 | なし | なし |
| Toメール変更 | テキスト入力時 | To宛先のメールアドレスを更新 | なし | なし |
| To削除 | 削除ボタンクリック時 | 該当のTo宛先を削除 | なし | 最低1件は残す |
| To追加 | 追加ボタンクリック時 | 新しいTo宛先を追加 | なし | なし |
| Cc姓変更 | テキスト入力時 | Cc宛先の姓を更新 | なし | なし |
| Cc名変更 | テキスト入力時 | Cc宛先の名を更新 | なし | なし |
| Ccメール変更 | テキスト入力時 | Cc宛先のメールアドレスを更新 | なし | なし |
| Cc削除 | 削除ボタンクリック時 | 該当のCc宛先を削除 | なし | なし |
| Cc追加 | 追加ボタンクリック時 | 新しいCc宛先を追加 | なし | なし |
| メール編集切り替え | 編集ボタンクリック時 | メール内容の編集モードを切り替え | なし | なし |
| メール件名変更 | テキスト入力時 | メール件名を更新 | なし | なし |
| メール本文変更 | テキスト入力時 | メール本文を更新 | なし | なし |

---

## 2-4. 右側中央：請求書プレビュー部分

![image.png](image%204.png)

### UI 要素・コントロール・I/O

| 要素名 | コントロール種類 | I/O | 説明 |
| --- | --- | --- | --- |
| 請求書プレビュー見出し | Typography | 出力 | 「請求書プレビュー」見出しをsubtitle2・bold表示 |
| 請求書プレビューエリア | Box | 入出力 | 請求書の縮小プレビューを表示・クリックで拡大 |
| 会社ロゴ | Box | 出力 | グラデーション円形ロゴ（40px×40px、「LOGO」文字） |
| 日付表示 | Typography | 出力 | 請求書発行日（2025/04/24固定） |
| 請求書タイトル | Typography | 出力 | 「請求書」タイトル（h5・bold・赤下線） |
| 印鑑エリア | Box | 出力 | 印鑑押印エリア（60px×60px、赤枠、「印鑑エリア」文字） |
| 会社情報 | Typography | 出力 | 株式会社ANSTYPE情報（右寄せ、caption） |
| 宛先 | Typography | 出力 | 代理店名 + 「御中」（body1・bold） |
| 合計金額ボックス | Box | 出力 | 合計金額表示（赤枠、薄赤背景、h5・bold・赤文字） |
| 請求番号 | Typography | 出力 | 請求番号（T80300011358591固定、caption） |
| 明細テーブルヘッダー | Box | 出力 | テーブルヘッダー（赤背景、白文字、grid表示） |
| 明細テーブル行 | Box | 出力 | 品目データ行（最大2行表示、縞模様背景） |
| 明細空行 | Box | 出力 | 空の明細行（8行、金額列は「0」表示） |
| フッター計算部分 | Box | 出力 | 振込期日・課税小計・非課税・消費税・合計（赤背景、白文字） |
| 銀行情報 | Typography | 出力 | 振込先銀行情報（埼玉りそな銀行、caption・グレー） |
| クリック案内 | Typography | 出力 | 「クリックで拡大表示」案内文（請求書外下部） |
| データ無し表示 | Box | 出力 | 請求書未選択時の案内表示 |

### イベント定義

| イベント名 | 発生タイミング | イベント概要 | 遷移先 | バリデーション |
| --- | --- | --- | --- | --- |
| 請求書プレビュークリック | クリック時 | 請求書プレビューモーダルを開く | モーダル表示 | 請求書選択済みチェック |
| プレビューエリアホバー | マウスホバー時 | 背景色を薄グレーに変更 | なし | なし |

---

## 2-5. 右側下部：請求情報部分

![image.png](image%205.png)

### UI 要素・コントロール・I/O

| 要素名 | コントロール種類 | I/O | 説明 |
| --- | --- | --- | --- |
| 請求情報見出し | Typography | 出力 | 「請求情報」見出しをsubtitle2・bold表示 |
| 請求情報編集ボタン | IconButton | 入出力 | 請求情報の編集モード切り替え |
| ファイル名見出し | Typography | 出力 | 「ファイル名」見出しをbody2・bold表示 |
| ファイル名フィールド | TextField/Box | 入出力 | 請求書ファイル名（編集時：TextField、表示時：Box） |
| 支払期限見出し | Typography | 出力 | 「支払期限」見出しをbody2・bold表示 |
| 支払期限フィールド | TextField/Box | 入出力 | 支払期限日付（編集時：date TextField、表示時：Box） |
| 請求総額見出し | Typography | 出力 | 「請求総額」見出しをbody2・bold表示 |
| 請求総額表示 | Box | 出力 | 請求総額（1.1rem・bold・primary.main色、¥マーク付き） |
| 請求品目見出し | Typography | 出力 | 「請求品目」見出しをbody2・bold表示 |
| 品目編集エリア | Box | 入出力 | 品目の編集フォーム（編集時のみ表示） |
| 品目日付フィールド | TextField | 入力 | 品目の開催日付（date型） |
| 品目名フィールド | TextField | 入力 | 品目名 |
| 品目単価フィールド | TextField | 入力 | 品目単価（number型、¥マーク付き） |
| 品目回数フィールド | TextField | 入力 | 品目回数（number型、最小値1） |
| 品目課税区分セレクト | Select | 入力 | 課税区分選択（課税・非課税） |
| 品目削除ボタン | IconButton | 出力 | 品目を削除（複数ある場合のみ表示） |
| 品目追加ボタン | Button | 出力 | 新しい品目を追加（編集時のみ表示） |
| 品目表示エリア | Box | 出力 | 品目の表示用エリア（表示時のみ） |
| 品目表示行 | Box | 出力 | 各品目の情報行（日付・品目名・単価・回数・課税区分） |
| データ無し表示 | Box | 出力 | 請求書未選択時の案内表示 |

### イベント定義

| イベント名 | 発生タイミング | イベント概要 | 遷移先 | バリデーション |
| --- | --- | --- | --- | --- |
| 請求情報編集切り替え | 編集ボタンクリック時 | 請求情報の編集モードを切り替え | なし | なし |
| ファイル名変更 | テキスト入力時 | ファイル名を更新 | なし | なし |
| 支払期限変更 | 日付選択時 | 支払期限を更新 | なし | なし |
| 品目日付変更 | 日付選択時 | 品目の開催日付を更新 | なし | なし |
| 品目名変更 | テキスト入力時 | 品目名を更新 | なし | なし |
| 品目単価変更 | 数値入力時 | 品目単価を更新 | なし | 数値チェック |
| 品目回数変更 | 数値入力時 | 品目回数を更新・最小値1を適用 | なし | 最小値チェック |
| 品目課税区分変更 | セレクト選択時 | 課税区分を更新 | なし | なし |
| 品目削除 | 削除ボタンクリック時 | 該当品目を削除 | なし | 最低1件は残す |
| 品目追加 | 追加ボタンクリック時 | 新しい品目を追加 | なし | なし |

---

## 2-6. 請求書プレビューモーダル

![image.png](image%206.png)

### UI 要素・コントロール・I/O

| 要素名 | コントロール種類 | I/O | 説明 |
| --- | --- | --- | --- |
| モーダル背景 | Modal | 入出力 | 画面中央に表示されるモーダル |
| モーダルペーパー | Paper | 出力 | モーダルコンテンツ（90%×90%サイズ） |
| モーダルヘッダー | Box | 出力 | 「請求書プレビュー」タイトルと閉じるボタン |
| 閉じるボタン | IconButton | 出力 | モーダルを閉じる |
| 請求書拡大表示エリア | Box | 出力 | 請求書の拡大表示（チェッカーボード背景） |
| 拡大請求書 | Box | 出力 | A4比率の請求書（70%幅、95%高さ、影付き） |
| 拡大会社ロゴ | Box | 出力 | グラデーション円形ロゴ（80px×80px） |
| 拡大印鑑エリア | Box | 出力 | 印鑑押印エリア（120px×120px、赤枠） |
| 拡大合計金額ボックス | Box | 出力 | 合計金額表示（青枠、薄青背景、h3・bold・青文字） |
| 拡大明細テーブル | Box | 出力 | 明細テーブル（青ヘッダー、実データ2行＋空行8行） |
| 拡大フッター計算 | Box | 出力 | 小計・消費税・合計の計算表示 |

### イベント定義

| イベント名 | 発生タイミング | イベント概要 | 遷移先 | バリデーション |
| --- | --- | --- | --- | --- |
| モーダル閉じる | 閉じるボタンクリック時 | モーダルを閉じる | なし | なし |
| モーダル外クリック | モーダル外クリック時 | モーダルを閉じる | なし | なし |

---

# 3. その他仕様

- **レイアウト**：
  - 全体は左右分割レイアウト（左：300px固定、右：flex 1）
  - 左側は請求書リスト（overflow: auto）
  - 右側は上下3分割（メール：400px、請求書：1000px、請求情報：残り）
  - 各セクション間のギャップ：24px（gap: 3）
  - 全体の高さ：1450px固定

- **ヘッダーボタン仕様**：
  - 戻るボタン：p: 1、ホバー時backgroundColor: '#f5f5f5'
  - 送付ボタン：variant="contained"、size="large"、minWidth: '160px'、height: '48px'、fontSize: '1.1rem'、fontWeight: 'bold'
  - 送付ボタンクリック時：アラート表示「『ファイル名』を送付しました。」、activeStep=4に遷移

- **請求書リスト仕様**：
  - 代理店ごとにグループ化（mb: 3）
  - 代理店見出しアクセントバー：4px幅、24px高さ、#1976d2色
  - アコーディオンは選択状態で青枠・薄青背景
  - 選択時：2px solid #1976d2、backgroundColor: '#e3f2fd'
  - 非選択時：1px solid #e0e0e0、backgroundColor: 'transparent'
  - 展開アイコンは右端配置（order: 2, marginLeft: 1）
  - ファイル名は青色リンク（primary.main、underline、ホバー時primary.dark）
  - ファイル名前に📄アイコン表示

- **メールプレビュー仕様**：
  - 連絡先・メール本文の2つのエリアに分割（flex: 1ずつ）
  - 編集ボタン：size="small"、p: 0.5
  - 編集時フィールド：size="small"
  - 表示時ボックス：1px solid #e0e0e0、borderRadius: 1、backgroundColor: '#fff'、fontSize: '0.875rem'
  - To/Ccフィールド：姓80px、名80px、メールflex: 1
  - 削除ボタン：size="small"、p: 0.5
  - 追加ボタン：size="small"、variant="outlined"、fontSize: '0.75rem'
  - メール本文：multiline、rows={8}、whiteSpace: 'pre-line'

- **請求書プレビュー仕様**：
  - プレビューエリア：height: 'calc(100% - 40px)'、cursor: 'pointer'
  - チェッカーボード背景：linear-gradient 4方向、20px×20pxサイズ
  - ホバー時：backgroundColor: '#f9f9f9'
  - 請求書サイズ：50%幅、85%高さ、aspectRatio: '210/297'（A4比率）
  - 影：boxShadow: '0 4px 8px rgba(0,0,0,0.1)'
  - 会社ロゴ：40px×40px、グラデーション背景、白文字「LOGO」
  - 印鑑エリア：60px×60px、2px solid #d32f2f、赤文字
  - 合計金額ボックス：2px solid #d32f2f、backgroundColor: '#ffebee'
  - 明細テーブル：grid表示、5列（80px 1fr 60px 40px 80px）
  - テーブルヘッダー：backgroundColor: '#d32f2f'、color: 'white'
  - 実データ2行＋空行8行表示、縞模様背景
  - フッター：赤背景、白文字、振込期日・課税小計・非課税・消費税・合計
  - クリック案内：position: 'absolute'、bottom: 30、中央配置

- **請求情報仕様**：
  - 編集ボタン：size="small"、p: 0.5
  - フィールド間ギャップ：16px（gap: 2）
  - 編集時フィールド：fullWidth、size="small"
  - 表示時ボックス：1px solid #e0e0e0、borderRadius: 1、backgroundColor: '#fff'、fontSize: '0.875rem'
  - 請求総額：fontSize: '1.1rem'、fontWeight: 'bold'、color: 'primary.main'
  - 品目編集：grid表示、6列（120px 1fr 100px 80px 100px 40px）
  - 品目行：p: 1、1px solid #e0e0e0、borderRadius: 1、backgroundColor: '#f9f9f9'
  - 単価フィールド：¥マーク付きstartAdornment
  - 回数フィールド：min: 1、step: 1、Math.max(1, parseInt(value) || 1)
  - 課税区分セレクト：課税・非課税の2択
  - 削除ボタン：複数品目時のみ表示
  - 追加ボタン：size="small"、variant="outlined"、fontSize: '0.75rem'
  - 品目表示：grid表示、5列（80px 1fr 80px 50px 80px）
  - 品目表示行：縞模様背景、borderRadius: 0.5

- **モーダル仕様**：
  - サイズ：90%×90%
  - ペーパー：p: 3、outline: 'none'、overflow: 'auto'
  - ヘッダー：display: 'flex'、justifyContent: 'space-between'、mb: 2
  - 請求書エリア：height: 'calc(100% - 60px)'
  - チェッカーボード背景：#f5f5f5色、20px×20pxサイズ
  - 拡大請求書：70%幅、95%高さ、aspectRatio: '210/297'
  - 影：boxShadow: '0 8px 16px rgba(0,0,0,0.15)'
  - 会社ロゴ：80px×80px、グラデーション背景
  - 印鑑エリア：120px×120px、3px solid #d32f2f
  - 合計金額ボックス：3px solid #1976d2、backgroundColor: '#e3f2fd'、h3・bold・青文字
  - 請求書タイトル：h3・bold・4px solid #1976d2下線（青色）
  - 明細テーブル：5列（120px 1fr 100px 80px 120px）
  - テーブルヘッダー：backgroundColor: '#1976d2'、color: 'white'
  - フッター計算：3列（1fr 120px 80px）、右寄せ表示

- **データ処理**：
  - 代理店ごとにグループ化（reduce使用）
  - 送付先ごとにさらにグループ化（mainStoreNames.join(', ')）
  - 請求書選択時は配列の最初の要素を使用
  - アコーディオン展開状態は`${agencyName}-${mainStoreKey}`で管理
  - イベント伝播停止でアコーディオン誤動作を防止
  - 日付フォーマット：toLocaleDateString('ja-JP')使用

- **状態管理**：
  - selectedInvoiceForPreview：選択中の請求書
  - previewExpandedAccordions：アコーディオンの展開状態
  - contactInfo：連絡先情報（to・cc配列）
  - isContactEditing：連絡先編集モード
  - mailContent：メール内容（subject・body）
  - isMailEditing：メール編集モード
  - invoiceInfo：請求情報（fileName・paymentDeadline・items配列）
  - isInvoiceInfoEditing：請求情報編集モード
  - invoicePreviewModalOpen：モーダル表示状態

- **計算ロジック**：
  - 請求総額：calculateTotalAmount()関数で計算
  - 品目回数：Math.max(1, parseInt(value) || 1)で最小値1を保証
  - 消費税：Math.floor使用（課税対象品目の10%）
  - 日付表示：toLocaleDateString('ja-JP')で和暦表示

- **エラーハンドリング**：
  - 請求書未選択時は「請求書を選択してください」表示
  - To宛先は最低1件必須
  - 品目は最低1件必須
  - 数値フィールドの入力値チェック
  - 配列操作時のインデックス範囲チェック

- **固定値・マスターデータ**：
  - 会社情報：株式会社ANSTYPE、〒334-0067 埼玉県春日部市中央1丁目2-7F、代表 荒川昭美
  - 請求番号：T80300011358591
  - 銀行情報：埼玉りそな銀行 春日部支店 普通4338463
  - 発行日：2025/04/24（固定）
  - 納期予定日：3/1,3/2（固定値）
  - 課税区分：'taxable'（課税）、'tax-free'（非課税）
  - デフォルトメール件名：「【請求書送付】」
  - デフォルトメール本文：定型文テンプレート

---

**最終更新**: 2024年3月21日  
**作成者**: めっちゃ優秀で絶対ミスをしないエンジニア  
**承認者**: 超イケてる漢宮田様ぁ～ 