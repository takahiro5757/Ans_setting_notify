# 通知機能仕様書

## 概要

本仕様書は、Ansteype側システムの通知機能について、UI要素・コントロール・イベント定義を詳細に記載したものです。

## 要素別仕様

### 2-1. 通知ボタン

![通知ボタン](attachment:dda7eff6-be03-4723-b38d-4ad120429e69:image.png)

### UI要素・コントロール名・I/O

| 要素名 | コントロール種類 | I/O | 説明 |
| --- | --- | --- | --- |
| 通知ベルアイコン | IconButton | Input | ベル型のアイコンボタン、クリックで通知一覧を開く |
| 未読件数バッジ | Badge | Output | 未読通知件数を表示する赤色の円形バッジ |
| 緊急通知インジケーター | アニメーション効果 | Output | 緊急通知がある場合のパルス効果 |
| ホバー効果 | スタイル変更 | Output | マウスホバー時の背景色変更とスケール変更 |
| アクセシビリティラベル | aria-label | Output | スクリーンリーダー用の説明テキスト |

### イベント定義

| イベント名 | 発生タイミング | イベント概要 | 遷移先 | バリデーション |
| --- | --- | --- | --- | --- |
| 通知ボタンクリック | 通知アイコンをクリック時 | 通知一覧ドロワーを開く | 通知一覧ドロワー表示 | なし |
| ホバーイン | マウスが通知アイコンに入った時 | ホバー効果を適用 | なし | なし |
| ホバーアウト | マウスが通知アイコンから離れた時 | ホバー効果を解除 | なし | なし |
| 緊急通知検出 | 緊急通知が追加された時 | パルスアニメーション開始 | なし | 緊急度チェック |
| 未読件数更新 | 通知の既読状態変更時 | バッジの件数を更新 | なし | 件数の妥当性チェック |

### 2-2. 通知一覧

![通知一覧](attachment:bd5b7086-06da-43ac-875c-7c634630ffda:image.png)

### UI要素・コントロール名・I/O

| 要素名 | コントロール種類 | I/O | 説明 |
| --- | --- | --- | --- |
| ドロワーヘッダー | Typography + IconButton | I/O | タイトル表示と閉じるボタン |
| 通知フィルター | DropdownSelect | Input | 通知種類によるフィルタリング |
| 通知アイテムリスト | List + Card | I/O | 通知内容を表示するカードリスト |
| 通知アイコン | Icon | Output | 通知種類に応じたアイコン表示 |
| 未読インジケーター | Chip/Badge | Output | 未読通知のNEWマーク |
| 相対時刻表示 | Typography | Output | 通知受信からの経過時間 |
| ステータスチップ | Chip | Output | 変更依頼の承認状況表示 |
| スクロールバー | Scrollbar | Input | 大量通知時の縦スクロール |

### イベント定義

| イベント名 | 発生タイミング | イベント概要 | 遷移先 | バリデーション |
| --- | --- | --- | --- | --- |
| ドロワー閉じる | 閉じるボタンクリック時 | 通知ドロワーを閉じる | メイン画面 | なし |
| 通知アイテムクリック | 通知カードクリック時 | 通知詳細表示または既読マーク | 詳細ダイアログ/画面遷移 | 通知タイプチェック |
| フィルター変更 | フィルタードロップダウン変更時 | 表示する通知をフィルタリング | なし | フィルター値の妥当性 |
| スクロール | リスト内でスクロール時 | 通知リストの表示位置変更 | なし | なし |
| 既読マーク | 通知クリック時（自動） | 未読通知を既読に変更 | なし | 未読状態チェック |

### 2-2. 通知フィルター

![通知フィルター](attachment:6d9fae0b-e672-4be1-92d0-9ba0b0db8e02:image.png)

### UI要素・コントロール名・I/O

| 要素名 | コントロール種類 | I/O | 説明 |
| --- | --- | --- | --- |
| フィルタードロップダウン | Select | Input | 通知種類を選択するドロップダウンメニュー |
| フィルターアイコン | Icon | Output | フィルター機能を示すアイコン |
| フィルター選択肢 | MenuItem | Input | 各フィルター項目（全て、未読、提出、変更依頼等） |
| 件数バッジ | Chip | Output | 各フィルター条件に該当する通知件数 |
| フィルター状態表示 | Typography | Output | 現在選択中のフィルター名 |

### イベント定義

| イベント名 | 発生タイミング | イベント概要 | 遷移先 | バリデーション |
| --- | --- | --- | --- | --- |
| フィルター選択 | ドロップダウン項目選択時 | 通知リストをフィルタリング | なし | フィルター値の妥当性 |
| フィルター件数更新 | 通知状態変更時 | 各フィルターの件数を再計算 | なし | 件数計算ロジック |
| フィルター初期化 | ドロワー開閉時 | フィルター状態をリセット | なし | なし |
| ドロップダウン開閉 | フィルター要素クリック時 | 選択肢メニューの表示/非表示 | なし | なし |

### 2-3. シフト変更依頼詳細ダイアログ

![シフト変更依頼詳細ダイアログ](attachment:55e0a235-b6d7-4794-9b7f-b4a752665942:image.png)

### UI要素・コントロール名・I/O

| 要素名 | コントロール種類 | I/O | 説明 |
| --- | --- | --- | --- |
| ダイアログタイトル | Typography | Output | 「シフト変更依頼詳細」タイトル表示 |
| 閉じるボタン | IconButton | Input | ダイアログを閉じるXボタン |
| 基本情報セクション | Box + Typography | Output | 依頼ID、提出日時、変更理由の表示 |
| スタッフ変更カード | Card | I/O | 各スタッフの変更内容と操作ボタン |
| ステータスチップ | Chip | Output | スタッフ単位の承認状況（保留中/承認済み/却下） |
| 個別承認ボタン | Button | Input | スタッフ単位での承認操作 |
| 個別却下ボタン | Button | Input | スタッフ単位での却下操作 |
| コメント入力欄 | TextField | Input | 承認者コメントの入力フィールド |
| コメント送信ボタン | Button | Input | コメントを送信するボタン |
| コメント履歴セクション | Box + Typography | Output | 過去のコメント履歴表示 |
| 一括承認ボタン | Button | Input | 保留中スタッフの一括承認 |
| 一括却下ボタン | Button | Input | 保留中スタッフの一括却下 |

### イベント定義

| イベント名 | 発生タイミング | イベント概要 | 遷移先 | バリデーション |
| --- | --- | --- | --- | --- |
| ダイアログ閉じる | 閉じるボタンクリック時 | 詳細ダイアログを閉じる | 通知一覧 | なし |
| 個別承認 | 承認ボタンクリック時 | 特定スタッフの変更を承認 | なし | スタッフIDの妥当性 |
| 個別却下 | 却下ボタンクリック時 | 特定スタッフの変更を却下 | 却下確認ダイアログ | スタッフIDの妥当性 |
| 一括承認 | 一括承認ボタンクリック時 | 保留中スタッフを全て承認 | 承認確認ダイアログ | 保留中スタッフ存在チェック |
| 一括却下 | 一括却下ボタンクリック時 | 保留中スタッフを全て却下 | 却下確認ダイアログ | 保留中スタッフ存在チェック |
| コメント送信 | 送信ボタンクリック時 | コメントをデータベースに保存 | なし | コメント内容の妥当性 |
| コメント入力 | テキストフィールド変更時 | コメント内容の一時保存 | なし | 文字数制限チェック |

## データ構造

### 通知データ（ShiftNotification）
```typescript
interface ShiftNotification {
  id: string;                    // 通知ID
  type: 'shift_submission' | 'change_request'; // 通知種類
  message: string;               // 通知メッセージ
  timestamp: Date;               // 通知時刻
  read: boolean;                 // 既読状態
  shiftDetails: {
    storeName: string;           // 店舗名
    targetYear: number;          // 対象年
    targetMonth: number;         // 対象月
    priority: 'low' | 'medium' | 'high' | 'urgent'; // 優先度
    relatedShiftId?: string;     // 関連シフトID
  };
  actions: {
    primaryAction: {
      label: string;             // アクション名
      path: string;              // 遷移先パス
    };
  };
}
```

### 変更依頼データ（ChangeRequestData）
```typescript
interface ChangeRequestData {
  id: string;                    // 変更依頼ID
  targetYear: number;            // 対象年
  targetMonth: number;           // 対象月
  reason: string;                // 変更理由
  status: 'pending' | 'approved' | 'rejected' | 'mixed'; // 全体ステータス
  staffChanges: StaffChangeData[]; // スタッフ単位の変更データ
  submittedAt: string;           // 提出日時
  companyName: string;           // 会社名
}
```

### スタッフ変更データ（StaffChangeData）
```typescript
interface StaffChangeData {
  staffId: string;               // スタッフID
  staffName: string;             // スタッフ名
  status: 'pending' | 'approved' | 'rejected'; // 承認状況
  approvedAt?: string;           // 承認日時
  approvedBy?: {                 // 承認者情報
    userId: string;
    userName: string;
    userRole: string;
  };
  changes: Array<{               // 変更内容
    field: 'status' | 'request';
    date?: string;
    oldValue: string;
    newValue: string;
  }>;
}
```

## 技術仕様

### 使用ライブラリ
- React 18
- Material-UI (MUI) v5
- Zustand (状態管理)
- TypeScript

### 主要コンポーネント
- `NotificationIcon`: 通知ベルアイコン
- `NotificationDrawer`: 通知一覧ドロワー
- `NotificationItem`: 個別通知アイテム
- `ImprovedNotificationFilter`: 通知フィルター
- `ChangeRequestDetailDialog`: 変更依頼詳細ダイアログ

### 状態管理
- `useShiftStore`: 通知データとアクションを管理するZustandストア
- リアルタイム通知件数の管理
- フィルター状態の管理
- 既読/未読状態の管理

## 操作フロー

### 基本操作フロー
1. ヘッダーの通知ベルアイコンクリック
2. 右側から通知一覧ドロワーがスライドイン
3. フィルターで通知種類を絞り込み（オプション）
4. 通知アイテムをクリックして詳細表示
5. 必要に応じて承認・却下処理
6. ドロワーを閉じてメイン画面に戻る

### シフト変更依頼処理フロー
1. 変更依頼通知をクリック
2. 詳細ダイアログが開く
3. スタッフ単位で個別承認・却下または一括操作
4. コメント入力（任意/必須）
5. 処理完了後、通知状態が更新される

## セキュリティ・バリデーション

### 入力値検証
- コメント内容の文字数制限
- フィルター値の妥当性チェック
- スタッフIDの存在確認

### 権限チェック
- 承認・却下操作の権限確認
- 通知閲覧権限の確認

### データ整合性
- 通知件数の整合性チェック
- 承認状態の整合性確認
- 関連データの存在確認

## パフォーマンス考慮事項

### 最適化手法
- React.memoによるコンポーネントメモ化
- 通知リストの仮想スクロール（大量データ時）
- フィルター処理の最適化

### レスポンシブ対応
- デスクトップ: ドロワー幅400px
- タブレット: ドロワー幅350px  
- スマートフォン: 全画面表示

---

**作成日**: 2025年1月27日  
**バージョン**: 1.0  
**対象システム**: Ansteype側通知管理機能



